---
title: "Migration Logistic Reg"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(lubridate)
library(rWind)
library(dplyr)
library(MuMIn)
library(lme4)

rm(list = ls())

```

```{r} 
create_AICc_table <- function(aicc){ # AICc table function
  aicc$Model <- rownames(aicc)
  aicc$deltaAICc <- aicc$AICc - min(aicc$AICc) 
  aicc$L <- exp(-0.5*(aicc$deltaAICc))
  aicc$weight <- aicc$L/(sum(aicc$L))
  aicc$weight.pct <- aicc$weight*100
  aicc <- arrange(aicc, aicc$deltaAICc)
  return(aicc)
}
```

### Data

The data used in the following analyses come from 158 bears between the years 2004 - 2016. I included data from May 1 - Sept 30. In order to align the temporal resolution of the spatial data (e.g., one sea ice map per day) with the GPS data, I use daily averages for all environmental variables. All variables are as follows:

* Sea Ice Concentration
  + Maximum sea ice concentration within 30 km radius of bear's location
  + Minimum sea ice concenration within 30 km radius
  + Mean sea ice concentration within 30 km radius
  + Quadratic term: mean SIC + mean SIC^2

* Environmental data from Movebank.org
  + Wind data (U and V vectors)
  + Charnock parameter (sea roughness)
  + Temperature (K) at 2m
  + Pressure at 2m

* Distance metrics
  + Distance to shore
  + Distance to pack ice (not included in this analysis)*

* Reproductive Status
  + 0 = no data
  + 1 = denning
  + 2 = coy
  + 3 = yearling
  

```{r}

load("logreg.RData")

# Stand alone vectors to bind to dataframes for later analyses
start.swim <- logreg$start.swim 
animal <- logreg$animal 

logreg <- logreg  %>% group_by(id) %>% slice(seq_len(min(which(start.swim == 1), n()))) 

oneLocation <- logreg %>% 
  group_by(id, ymd) %>%
  arrange(id.datetime) %>%
  slice(n()) 

```
 

The following models are either Generalized Linear Models or Generalized Linear Mixed Models (logistic regression) in which 

0 = On ice (n = 99,510)
1 = Departure from ice (n = 12)

Thus, the data is very zero-inflated. I am planning to address this issue by using a Known Fate (survival) model in Rmark for my final analyses. These analyses are preliminary, though I expect the final results to be similar.

All points after the predetermined 'departure date' have been removed for land bears. As a reminder, the departure date has been defined as the last GPS point on ice during the open water season. To determine this point, I used NSIDC's MASIE ice data(0 = not ice and 1 = ice). Bears that vacillate extensively between ice and land have been removed from this analysis (per emails with D. Douglas and T. Atwood).








Add environmental data from Movebank.org and format

* wind data (U and V vectors)  
* Charnock Parameter   
* Temp (K) at 2m   
* Pressure at 2m   

```{r}

wind <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank_07032020.csv")

colnames(wind) <- c("datetime", "long", "lat", "ht_above_ellips", "id", "Charnock_Parameter", "Wind_U_ECMWF_10m", "Temp_K_ECMWF_2m", "Pressure_2m", "Wind_U_NARR_10m", "Wind_V_NARR_10m", "Temp_K_NARR_2m", "Pressure_Sea_Level_ECMWF", "Wind_V_ECMWF_10m")

wind$datetime <- ymd_hms(wind$datetime)
wind$datetime <- with_tz(wind$datetime, "US/Alaska")

which(is.na(wind$Wind_U_NARR_10m))
which(is.na(wind$Wind_V_NARR_10m))
which(logreg$start.swim == 1) # no start swim has NA for wind vectors - can delete these rows where wind = NA

# bind start.swim to wind so can run regressions

wind <- cbind(wind, start.swim)
wind <- cbind(wind, animal)
#wind$start.swim <- as.factor(wind$start.swim)

# Remove NA's 

wind <- wind[!is.na(wind$Wind_U_NARR_10m),]
wind <- wind[!is.na(wind$Wind_V_NARR_10m),]


rwind <- uv2ds(wind$Wind_U_NARR_10m, wind$Wind_V_NARR_10m)

wind <- cbind(wind, rwind)

wind <- wind  %>% group_by(id) %>% slice(seq_len(min(which(start.swim == 1), n()))) # remove data for land bears after start.swim = 1

head(wind)
```


# Logistic Regression - SEA ICE CONCENTRATION 

First I will determine which measurement of Sea Ice Concentration is best using a Generalized Linear Model (logistic regression)

* SIC_30m_max = maximum sea ice concentation within 30 km radius
* SIC_30m_me  = mean sea ice concentration within 30 km radius
* SIC_sq      = mean sea ice concentration quadratic: SIC + SIC^2

```{r}

fit_max <- glm(start.swim ~ SIC_30m_max, data = logreg, family = binomial())
#summary(fit_max)

fit_SIC_mean <- glm(start.swim ~ SIC_30m_me, data = logreg, family = binomial())
#summary(fit_SIC_mean)

fit_SIC_sq <- glm(start.swim ~ SICsq, data = logreg, family = binomial())
#summary(fit_SIC_sq)

aicc <- AICc(fit_max, fit_SIC_mean, fit_SIC_sq)

create_AICc_table(aicc)

```

SIC as a quadratic term fits best, though is only narrowly better than SIC_mean. 


### Sea Ice Concentration: Does it change results to use a mixed model? 

Determine which measurement of Sea Ice Concentration is best using a Generalized Linear Mixed Model (logistic regression)

```{r}

fit_max <- glmer(start.swim ~ SIC_30m_max + (1|animal), data = logreg, family = binomial())
#summary(fit_max)

fit_SIC_mean <- glmer(start.swim ~ SIC_30m_me + (1|animal), data = logreg, family = binomial())
#summary(fit_SIC_mean)

fit_SIC_sq <- glmer(start.swim ~ SICsq + (1|animal), data = logreg, family = binomial())
#summary(fit_SIC_sq)

aicc <- AICc(fit_max, fit_SIC_mean, fit_SIC_sq)

create_AICc_table(aicc)

```

Results do not change when using a mixed model. However, SIC-squared is now substantially better than SIC mean. 


### Do results change when using one location per day?

```{r}
fit_max <- glmer(start.swim ~ SIC_30m_max + (1|animal), data = oneLocation, family = binomial())
#summary(fit_max)

fit_SIC_mean <- glmer(start.swim ~ SIC_30m_me + (1|animal), data = oneLocation, family = binomial())
#summary(fit_SIC_mean)

fit_SIC_sq <- glmer(start.swim ~ SICsq + (1|animal), data = oneLocation, family = binomial())
#summary(fit_SIC_sq)

aicc <- AICc(fit_max, fit_SIC_mean, fit_SIC_sq)

create_AICc_table(aicc)

```

Results do not qualitatively change but fit seems slightly better and the quadratic term is now even more improved over the mean or max terms.


# Wind 


# Movebank Logistic Regression
I used a regular GLM for this (no random effect) because I was getting errors about a singular fit (i.e., the model is overfitted). 

```{r}
# add start.swim column to movebank df to run logistic regression


Charnock <- glm(start.swim ~ Charnock_Parameter, data = wind, family = binomial())
temp <- glm(start.swim ~ Temp_K_ECMWF_2m, data = wind, family = binomial())
pressure <- glm(start.swim ~ Pressure_2m, data = wind, family = binomial())
windspeed <- glm(start.swim ~ speed, data = wind, family = binomial())
dir <- glm(start.swim ~ dir, data = wind, family = binomial())
#test <- glm(start.swim~test, data = wind, family = binomial()) # random numbers were not significant

# Create row of random numbers

#wind$test <- sample(100, size = nrow(wind), replace = TRUE)



aicc <- AICc(Charnock, temp, pressure, windspeed, dir)

create_AICc_table(aicc)


```

--> Windspeed is clearly the most important of these variables. Windspeed, temperature, and Charnock parameter were all significant. None were correlated > 0.4.

# Comparing Sea Ice Concentration, Wind Speed, and SIC*Wind Speed (interaction) in a GLMM
Interaction between SIC and speed was best model of SIC quadratic, Speed, and SIC * Speed


```{r}

windspeed <- wind$speed

logreg <- inner_join(logreg, wind)

speed <- glmer(start.swim ~ speed + (1|animal), data = logreg, family = binomial())
SIC <- glmer(start.swim ~ SICsq + (1|animal), data = logreg, family = binomial())
speed_SIC <- glmer(start.swim ~ speed*SICsq + (1|animal), data = logreg, family = binomial())

aicc <- AICc(speed, SIC, speed_SIC)
create_AICc_table(aicc)
```

An interaction between SIC and Windspeed is clearly the best model of these three


# Reproductive Status

I ran competing models to see how I should define reproductive status. My options were as follows:

* As Factor variable
  + 0 = none/unknown
  + 1 = denning
  + 2 = coy
  + 3 = yearling 
  
* Binary variable
  + 0 = no data/no young/denning
  + 1 = coy or yearling
  
* Factor variable
  + 0 = no data/no young
  + 1 = denning
  + 2 = coy or yearling
  
The best choice was the first - dividing into all four categories. Reproductive status is a significant variable. 

``` {r}
logreg$repro <- 0

logreg <- logreg %>%
  mutate(repro = replace(repro, DenYr == 1, 1)) %>%
  mutate(repro = replace(repro, coy == 1, 2)) %>%
  mutate(repro = replace(repro, yearling == 1, 3))

logreg$repro <- factor(logreg$repro, labels = c("Unknown", "Denning", "COY", "Yearling"))

fit_repro <- glmer(start.swim ~ repro + (1|animal), data = logreg, family = binomial())

summary(fit_repro)

```


# Distance to land

I was unable to use a mixed effects model for this variable due to the same error: singular fit. Here is a summary of the results as a GLM. Results are below.

```{r, echo = FALSE}

fit_d2l <- glm(start.swim ~ dist2land[,1], data = logreg, family = binomial())
summary(fit_d2l)

```


