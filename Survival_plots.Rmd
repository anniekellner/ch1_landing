---
title: "Plots"
author: "Annie Kellner"
date: "11/4/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(MuMIn)
library(survival)

rm(list = ls())

```

```{r Load data}

load("Cox_TDC.RData")
head(cox_tdc)

```

# Hold SIC constant at the mean and plot hazard for windspeed

```{r AICc Sea Ice Concentration}

SIC_max <- coxph(Surv(tstart, tstop, migrate) ~ SIC_max, cluster = id, data = cox_tdc) # This is the mean value of the maximum sea ice concentration over all observations in one day
SIC_mean <- coxph(Surv(tstart, tstop, migrate) ~ SIC_mean, cluster = id, data = cox_tdc)
SIC_sq <- coxph(Surv(tstart, tstop, migrate) ~ SICsq, cluster = id, data = cox_tdc)
#SIC_min <- coxph(Surv(tstart, tstop, migrate) ~ SIC_min, cluster = id, data = cox_tdc) # Does not converge

aicc <- AICc(SIC_mean, SIC_max, SIC_sq)

create_AICc_table(aicc) 

```

Using the square of the mean sea ice concentration is the best way to measure sea ice concentration.

```{r AICc CoxPH 3 day moving window}

# About the model: http://www.sthda.com/english/wiki/cox-proportional-hazards-model

# 3 days rolling mean for all variables

library(zoo)

cox_tdc <- cox_tdc %>%
  mutate(SICsq_3davg = rollmean(SICsq, 3, fill = NA, align = "right")) %>%
  mutate(Windspeed_3davg = rollmean(Windspeed, 3, fill = NA, align = "right")) %>%
  mutate(Dist2land_3davg = rollmean(Distance_to_land, 3, fill = NA, align = "right"))

# Same models using 3 day rolling averaqes for all variables

speed3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg, cluster= animal, data = cox_tdc)

SIC3 <- coxph(Surv(tstart, tstop, migrate) ~ SICsq_3davg, cluster = animal, data = cox_tdc)

Speed_SIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg*SICsq_3davg, cluster = animal , data = cox_tdc)

distance3 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg, cluster = animal , data = cox_tdc)

distSpeed3 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg, cluster = animal, data = cox_tdc)

distSpeedSIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg * SICsq_3davg, cluster = animal, data = cox_tdc)
SpeedPlsSIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq_3davg, cluster = animal, data = cox_tdc)
distSpeedPlsSIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq_3davg + Dist2land_3davg, cluster = animal, data = cox_tdc)
null3 <- coxph(Surv(tstart, tstop, migrate) ~1, data = cox_tdc, cluster = animal)


aicc <- AICc(speed3, SIC3, Speed_SIC3, distance3, distSpeed3, distSpeedSIC3, SpeedPlsSIC3, distSpeedPlsSIC3, null3)

create_AICc_table(aicc)

```

The top model using a 3-day moving window is Distance + Speed.

```{r 3-day summary}

summary(distSpeed3)
```

The effect size of windspeed is HUGE. The hazard ratio is 2.51, meaning that each increase in windspeed by 1 m/s (over a 3-day average) increases the hazard by 151% (check this interpretation). Distance to land is significant but since the value is 1 we cannot conclude any directional effect. 

```{r}


library(stringr)
library(tidyverse)

fit.one <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg, cluster = animal, data = cox_tdc)

fit.two <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq_3davg + Dist2land_3davg, cluster = animal, data = cox_tdc)


# Extract windspeed and SICsq data from Surv object

covs <- attr(fit.one$strata, "names")
covs <-str_split(covs, ",")
covs <- data.frame(matrix(unlist(covs), nrow=length(covs), byrow=T))
colnames(covs) <- c("Windspeed_3davg", "SICsq")
covs <- covs %>%
  mutate_all(~gsub("MeanWindspeed=", "", .)) %>%
  mutate_all(~gsub("SICsq=", "", .))

covs$Windspeed <- as.numeric(covs$Windspeed)
covs$SICsq <- as.numeric(covs$SICsq)


# Bind back to tidy dataframe

tidy_model <- tidy_model %>%
  dplyr::select(-strata) %>%
  bind_cols(covs)



```

Example: How to add variables and predict over new dataframe when using time-dependent covariates

From ```{r [pammtools' Time-Dependent Covariates](https://adibender.github.io/pammtools/articles/tdcovar.html)}``` 

```{r eval= FALSE}

rm(list= ls())

library(mgcv)
library(dplyr)
library(survival)
library(pammtools)
library(ggplot2)


data("pbc", package = "survival")
head(pbc)[, c(1:5, 11, 12)]
head(pbcseq)[, c(1, 4:5, 7, 12, 13)]

pbc <- pbc %>% mutate(bili = log(bili), protime = log(protime)) # log = e^x = y; y = bili
pbcseq <- pbcseq %>% mutate(bili = log(bili), protime = log(protime))

temp <- subset(pbc, id <= 312, select = c(id:sex)) # baseline
pbc2 <- tmerge(temp, temp, id = id, death = event(time, status)) #set range
pbc2 <- tmerge(pbc2, pbcseq, id = id, bili = tdc(day, bili),
  protime = tdc(day, protime))

fit1 <- coxph(Surv(time, status == 2) ~ bili + protime, pbc)
fit2 <- coxph(Surv(tstart, tstop, death == 2) ~ bili + protime, pbc2)
rbind("baseline fit" = coef(fit1), "time dependent" = coef(fit2))


pbc <- pbc %>% filter(id <= 312) %>%
  select(id:sex, bili, protime) %>%
  mutate(status = 1L * (status == 2)) # Turns status == 2 to status == 1

pbc_ped <- as_ped( # I don't need to do this because I'm not interested in piecewise exponential data
  data = list(pbc, pbcseq),
  formula = Surv(time, status) ~ . + concurrent(bili, protime, tz_var = "day"),
  id = "id")

pbc_pam <- gam(ped_status ~ s(tend) + bili + protime, data = pbc_ped,
  family = poisson(), offset = offset)
cbind(pam = coef(pbc_pam)[2:3], cox = coef(fit2))

reference = sample_info(pbc_ped) # means for all values


bili_df <- pbc_ped %>% ungroup() %>%
  make_newdata(bili = seq_range(bili, n = 100)) %>% # everything held at average except bili
  add_term(pbc_pam, term = "bili", reference = reference) %>%
  mutate(cox = predict(fit2, ., type = "term")[, "bili"])

## Effect of protime - same thing as bili but for protime
protime_df <- pbc_ped %>% ungroup() %>%
  make_newdata(protime = seq_range(protime, n=100)) %>%
  add_term(pbc_pam, term = "protime", reference = reference) %>% # not needed when just using coxph?
  mutate(cox = predict(fit2, ., type = "term")[, "protime"])

# visualization
# remember that bili and protime are log transformed

p_term <- ggplot(data = NULL, aes(y = fit)) + geom_line(aes(col = "PAM")) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  geom_line(aes(y = cox, col = "Cox")) +
  scale_colour_manual(name = "Method", values = c("#E41A1C", "#000000"))
gridExtra::grid.arrange(
  p_term %+% bili_df + aes(x = exp(bili)),
  p_term %+% protime_df + aes(x = exp(protime)),
  nrow = 1L)
```

Attempting to follow this procedure for pb data

```{r}

library(dplyr)
library(survival)
library(pammtools)
library(ggplot2)
library(tidyverse)
library(stringr)

fit <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg, cluster = animal, data = cox_tdc) # Model = DistSpeed3

surv_fit <- survfit(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg, cluster = animal, data = cox_tdc)

tidyfit <- broom::tidy(fit)

tidy_survfit <- broom::tidy(surv_fit)

# Extract windspeed and SICsq data from Surv object

covs <- attr(surv_fit$strata, "names")
covs <-str_split(covs, ",")
covs <- data.frame(matrix(unlist(covs), nrow=length(covs), byrow=T))
colnames(covs) <- c("Dist2land_3davg", "Windspeed_3davg")
covs <- covs %>%
  mutate_all(~gsub("Dist2land_3davg=", "", .)) %>%
  mutate_all(~gsub("Windspeed_3davg=", "", .))
 
covs$Windspeed_3davg <- as.numeric(covs$Windspeed_3davg)
covs$Dist2land_3davg <- as.numeric(covs$Dist2land_3davg)

covs <- cbind(tidy_survfit, covs)
covs <- dplyr::select(covs, -strata)
windspeed <- covs$Windspeed_3davg

cox_tdc$risk <- predict(fit, newdata = cox_tdc, type = "risk", reference = "sample", na.action = na.pass)

cox_tdc <- na.omit(cox_tdc)
cox_tdc

new <- covs %>%
  make_newdata(Windspeed_3davg = seq_range(Windspeed_3davg, n = 100)) 

new <- new %>%
  mutate(HR = predict(fit, ., type = "risk", na.action = na.pass))


  mutate(risk = predict(fit, ., type = "risk", na.action = na.pass))

ggplot(data = new) + 
  aes(x = Windspeed_3davg, y = HR) + 
  geom_line()

```

