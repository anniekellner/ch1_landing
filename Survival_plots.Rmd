---
title: "Plots"
author: "Annie Kellner"
date: "11/4/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Null model 

```{r}
# Survival curve 

fit <- survfit(Surv(tstart, tstop, start.swim) ~ MeanWindspeed + SICsq, data = avg2)   
fit_data <- data.frame(cbind(null_fit$time,null_fit$surv,null_fit$cumhaz,null_fit$upper,null_fit$lower))
names(fit_data) <- c("time","surv","cumhaz","upperCI","lowerCI")

ggplot(data=NULL) +
  geom_line(data=fit_data,aes(x=time, y=surv),colour="black",linetype="solid",size=1) +
  geom_line(data=fit_data,aes(x=time, y=upperCI),colour="black",linetype="dashed",size=.5) +
  geom_line(data=fit_data,aes(x=time, y=lowerCI),colour="black",linetype="dashed",size=.5) +
  #scale_x_continuous(breaks=seq(0,480,120)) +
  #scale_y_continuous(breaks=seq(0,1,.25)) +
 # expand_limits(x=c(0,480),y=c(0,1)) +
  xlab("") + ylab("Survival Function") +
theme_classic() +
theme(axis.line.x = element_line(color = "black"),
      axis.line.y = element_line(color = "black"))

# Cumulative hazard

ggplot(data=NULL) +
  geom_line(data=null_data,aes(x=time, y=cumhaz),colour="black",linetype="solid",size=1) +
  #scale_x_continuous(breaks=seq(0,480,120)) +
 # scale_y_continuous(breaks=seq(0,1,.25)) +
  #expand_limits(x=c(0,480),y=c(0,1)) +
  xlab("Ordinal Day") + ylab("Cumulative Hazard Function") +
theme_classic() +
theme(axis.line.x = element_line(color = "black"),
      axis.line.y = element_line(color = "black"))

```

# Plot cumulative hazard for whole model

```{r}

modelfit <- survfit(Surv(tstart, tstop, start.swim) ~ MeanWindspeed + SICsq, cluster = animal, data = avg2)
print(modelfit)
summary(modelfit)

modeldata <- data.frame(cbind(modelfit$time,modelfit$surv,modelfit$cumhaz,modelfit$upper,modelfit$lower))

cumhaz <- modeldata %>%
  group_by(time) %>%
  summarize(mean_cumhaz = mean(cumhaz))

ggplot(data=NULL) +
  geom_line(data=cumhaz,aes(x=time, y=mean_cumhaz),colour="black",linetype="solid",size=1) +
  #scale_x_continuous(breaks=seq(0,480,120)) +
 # scale_y_continuous(breaks=seq(0,1,.25)) +
  #expand_limits(x=c(0,480),y=c(0,1)) +
  xlab("Ordinal Day") + ylab("Cumulative Hazard Function") +
theme_classic() +
theme(axis.line.x = element_line(color = "black"),
      axis.line.y = element_line(color = "black"))



```
# Hold SIC constant at the mean and plot hazard for windspeed


```{r}
# Trial from Shane Frank email 11/5/2020

library(stringr)
library(tidyverse)

modelfit <- survfit(Surv(tstart, tstop, start.swim) ~ MeanWindspeed + SICsq, cluster = animal, data = avg2)

tidy_model <- broom::tidy(modelfit)

# Extract windspeed and SICsq data from Surv object

covs <- attr(modelfit$strata, "names")
covs <-str_split(covs, ",")
covs <- data.frame(matrix(unlist(covs), nrow=length(covs), byrow=T))
colnames(covs) <- c("Windspeed", "SICsq")
covs <- covs %>%
  mutate_all(~gsub("MeanWindspeed=", "", .)) %>%
  mutate_all(~gsub("SICsq=", "", .))

covs$Windspeed <- as.numeric(covs$Windspeed)
covs$SICsq <- as.numeric(covs$SICsq)


# Bind back to tidy dataframe

tidy_model <- tidy_model %>%
  dplyr::select(-strata) %>%
  bind_cols(covs)


# Calculates mean value for all variables

predict(SpeedPlsSIC, newdata = my.new.data, se.fit = TRUE, type = "survival")


new <- tidy_model %>% make_newdata(Windspeed = seq_range(Windspeed, n = 100)) # 100 values between min and max windspeed in new dataframe

predicted <- predict(SpeedPlsSIC, new, type = "survival")

new <- new %>% 
  mutate(cphfit = predict(SpeedPlsSIC, ., type = "survival"))
 


gg <- ggplot(new, aes(x = MeanWindspeed, y=cphfit)) +
    #geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha=0.3) +
    geom_line(aes(y=cphfit, col="black")) +
  ylab(expression(hat(f)(x))) + theme(legend.position="none")

speed_gg <- gg + aes(x=MeanWindspeed) + xlab("Windspeed (m/s)")

t <- as.data.frame(new$cphfit)

#https://adibender.github.io/pammtools/articles/tdcovar.html

```
