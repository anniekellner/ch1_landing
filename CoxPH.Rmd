---
title: "CoxPH"
author: "Annie Kellner"
date: "8/24/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(lubridate)
library(rWind)
library(dplyr)
library(MuMIn)
#library(DescTools)
library(survival)
library(survminer)
library(tmap)
library(raster)
library(sf)

rm(list = ls())

```

```{r Functions}
# Functions

create_AICc_table <- function(aicc){ # AICc table function
  aicc$Model <- rownames(aicc)
  aicc$deltaAICc <- aicc$AICc - min(aicc$AICc) 
  aicc$L <- exp(-0.5*(aicc$deltaAICc))
  aicc$weight <- aicc$L/(sum(aicc$L))
  aicc$weight.pct <- aicc$weight*100
  aicc <- arrange(aicc, aicc$deltaAICc)
  return(aicc)
}

```


I included data from June 1 - Sept 30. In order to align the temporal resolution of the spatial data (e.g., one sea ice map per day) with the GPS data, I use daily averages for all environmental variables. 

```{r Prep Data}

load("land_bears_CoxPH.RData")

bears <- distinct(bears)

bears <- bears %>%
  mutate(SICsq = SIC_30m_me^2) # Add SIC-squared

```



```{r add wind}

# Combine three separate Movebank spreadsheets (data obtained in separate requests)

wind1 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_07032020.csv") 
wind2 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_10082020.csv")
wind3 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_10192020.csv")

wind1 <- dplyr::select(wind1, timestamp, location.long, location.lat, ht.above.ellipsoid, id, NCEP.NARR.FLX.U.Wind.at.10.m.above.Ground, NCEP.NARR.FLX.V.Wind.at.10.m.above.Ground) # eliminate other environmental variables like Chinook parameter

wind <- rbind(wind1, wind2, wind3)
wind$timestamp <- ymd_hms(wind$timestamp, tz = "UTC") # datetime imported as factor from csv. Change to POSIXct object.

# Eliminate ice bears (from wind1)

lb <- unique(bears$id)
wind <- subset(wind, wind$id %in% lb)
wind <- distinct(wind)

colnames(wind) <- c("datetime", "gps_lon", "gps_lat", "ht_above_ellips", "id", "Wind_U", "Wind_V") # wind vectors NCEP NARR FLX
wind$datetime <- with_tz(wind$datetime, "US/Alaska")

wind.join <- left_join(bears, wind, by = c("datetime","id", "gps_lon", "gps_lat"))

rwind <- uv2ds(wind.join$Wind_U, wind.join$Wind_V)

wind.join <- cbind(wind.join, rwind)
wind.join$yday <- yday(wind.join$datetime)

# Find average
# Note: for average "Wind Type", used 'first' direction of the day

avg <- wind.join %>% # Compute daily average
  group_by(id, yday) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(SICsq), mean(dist2land), max(start.swim), mean(speed)) %>%
  ungroup()

colnames(avg) <- c("id", "ordinal_day", "animal", "SIC_mean", "SIC_max", "SIC_min", "SICsq", "MeanDist2land", "start.swim", "Windspeed") 

avg <- avg %>%
  group_by(id) %>%
  mutate(day = row_number()) 

avg <- avg %>%
  group_by(id) %>%
  mutate(across(everything(),
                ~replace(., row_number() > match(1, start.swim), NA)))

```

```{r use tmerge function to create tdc dataframe}

temp <- subset(avg, start.swim == 1)
temp <- temp %>%
  dplyr::select(id, day, start.swim) 

baseline <- tmerge(temp, temp, id = id, migrate = event(day, start.swim))

cox_tdc <- tmerge(baseline, avg, id = id, SIC_mean = tdc(day, SIC_mean), SIC_max = tdc(day, SIC_max), SIC_min = tdc(day, SIC_min), SICsq = tdc(day, SICsq), Distance_to_land = tdc(day, MeanDist2land), Windspeed = tdc(day, Windspeed))

```


## SEA ICE CONCENTRATION 

First I determined which measurement of Sea Ice Concentration is best 

* SIC_max   = maximum sea ice concentation within 30 km radius
* SIC_mean  = mean sea ice concentration within 30 km radius
* SIC_min   = minimum sea ice concentration within 30 km radius
* SIC_sq    = mean sea ice concentration quadratic: SIC + SIC^2

```{r}

# CoxPH (baseline hazard not specified)

SIC_max <- coxph(Surv(tstart, tstop, migrate) ~ SIC_max, cluster = id, data = cox_tdc)
#SIC_maxMax <- coxph(Surv(tstart, tstop, migrate) ~ SICmaxMax, cluster = animal, data = avg)
SIC_mean <- coxph(Surv(tstart, tstop, migrate) ~ SIC_mean, cluster = id, data = cox_tdc)

SIC_sq <- coxph(Surv(tstart, tstop, migrate) ~ SICsq, cluster = id, data = cox_tdc)

SIC_min <- coxph(Surv(tstart, tstop, migrate) ~ SIC_min, cluster = id, data = cox_tdc) # Does not converge
#SIC_minMean <- coxph(Surv(tstart, tstop, migrate) ~ SIC_minMean, data = cox_tdc)

aicc <- AICc(SIC_mean, SIC_max, SIC_sq)

create_AICc_table(aicc) # SICsq is best way to measure SIC after changing 120 -> 0 and re-doing faulty numbers

```


```{r}

speed <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed, cluster= id, data = cox_tdc)
SIC <- coxph(Surv(tstart, tstop, migrate) ~ SICsq, cluster = id, data = cox_tdc)
Speed_SIC <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed*SICsq, cluster = id, data = cox_tdc)
distance <- coxph(Surv(tstart, tstop, migrate) ~ Distance_to_land, cluster = id, data = cox_tdc)
distSpeed <- coxph(Surv(tstart, tstop, migrate) ~ Distance_to_land + Windspeed, cluster = id, data = cox_tdc)
distSpeedSIC <- coxph(Surv(tstart, tstop, migrate) ~ Distance_to_land + Windspeed * SICsq + Windspeed + SICsq, cluster = id, data = cox_tdc)
SpeedPlsSIC <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed + SICsq, cluster = id, data = cox_tdc)
distSpeedPlsSIC <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed + SICsq + Distance_to_land, cluster = id, data = cox_tdc)
null <- coxph(Surv(tstart, tstop, migrate) ~1, data = cox_tdc)


aicc <- AICc(speed, SIC, Speed_SIC, distance, distSpeed, SpeedPlsSIC, distSpeedPlsSIC, null)
aicc_table <- create_AICc_table(aicc)

write.csv(aicc_table, file = "C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Results/aicc.csv")

create_AICc_table(aicc)

summary(SpeedPlsSIC)


```

```{r}
# About the model: http://www.sthda.com/english/wiki/cox-proportional-hazards-model

summary(SpeedPlsSIC)
summary(SIC)

```


z = Wald statistic value ( = ratio of each coefficient to its standard error) MaxSICmax is significant in and of itself but windspeed is not. The interaction is highly significant. 

All three overall tests (likelihood ratio, Wald test, logrank test) are significant. 

exp(coef) is the hazard ratio.  

```{r}

# Schoenfeld's residuals

zph <- cox.zph(SpeedPlsSIC)
zph

plot(zph[2], lwd = 2)
abline(0,0, col = 1, lty = 3, lwd = 2)
abline(h= Speed_SIC$coef[2], col=3, lwd=2, lty=2)
legend("topleft",
legend=c('Reference line for null effect',
"Average hazard over time",
"Time-varying hazard"),
lty=c(3,2,1), col=c(1,3,1), lwd=2)
```


# Plots

```{r}

fit <- survfit(Surv(tstart, tstop, start.swim) ~ Windspeed + SICsq, cluster = animal, data = avg2) # SIC + Speed - this doesn't work


ggadjustedcurves()

ggsurvplot(fit, data = avg2)

```

# Reproduction

``` {r}

bears$repro <- 0

bears <- bears %>%
  mutate(repro = replace(repro, go_into_den == 1, 1)) %>%
  mutate(repro = replace(repro, coy == 1, 2)) %>%
  mutate(repro = replace(repro, yearling == 1, 3))

bears$repro <- factor(bears$repro, labels = c("Unknown", "Enter_Den", "COY", "Yearling"))

avg <- bears %>% 
  group_by(id, ymd) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(SICsq), mean(dist2land[,1]), max(start.swim), first(repro), max(Bonepile)
    )

colnames(avg) <- c("id", "datetime", "animal", "SIC_mean", "SIC_max", "SIC_min", "SICsq", "Dist2land", "start.swim", "repro", "Bonepile")

avg$yday_start <- yday(avg$datetime) 

avg <- avg %>%
  mutate(yday_stop = lead(yday_start))

#load("ded_ids.RData")

#sub <- subset(avg, id %in% ded)

avg <- avg %>%
  group_by(id) %>%
  mutate(across(starts_with('yday'),
                ~replace(., row_number() > match(1, start.swim), NA)))

repro <- coxph(Surv(yday_start, yday_stop, start.swim) ~ repro, data = avg)

summary(repro)
```


No bears with COYS came ashore. Denning is significantly associated with cming to shore. Having a yearling is positively related to going to shore but the result is not significant. 

```{r}




```

