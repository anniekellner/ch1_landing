---
title: "CoxPH"
author: "Annie Kellner"
date: "8/24/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(lubridate)
library(rWind)
library(dplyr)
library(MuMIn)
#library(DescTools)
library(survival)
library(survminer)
library(tmap)
library(raster)
library(sf)

rm(list = ls())

```

```{r}
# Functions

create_AICc_table <- function(aicc){ # AICc table function
  aicc$Model <- rownames(aicc)
  aicc$deltaAICc <- aicc$AICc - min(aicc$AICc) 
  aicc$L <- exp(-0.5*(aicc$deltaAICc))
  aicc$weight <- aicc$L/(sum(aicc$L))
  aicc$weight.pct <- aicc$weight*100
  aicc <- arrange(aicc, aicc$deltaAICc)
  return(aicc)
}

```

```{r}

# Projections

polar.stereo <- CRS('+proj=stere +lat_0=90 +lat_ts=60 +lon_0=-80 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +units=m + datum=WGS84 +no_defs +towgs84=0,0,0') 
```


N = 23 migrations; 17 individuals

I included data from June 1 - Sept 30. In order to align the temporal resolution of the spatial data (e.g., one sea ice map per day) with the GPS data, I use daily averages for all environmental variables. 

```{r}

# Prep Data

load("land_bears_CoxPH.RData")

bears <- distinct(bears)

ss <- subset(bears, start.swim == 1) # 19 swims

```

```{r, eval= FALSE}

# Map land bears 

tmap_mode(mode = "view")

tm_shape(lb) +
  tm_symbols(col = "month") +
  tm_facets(by = "id")

```


```{r}

# Prep Data

bears <- bears %>%
  mutate(SICsq = SIC_30m_me^2) # Add SIC-squared

avg <- bears %>% # Compute daily average
  group_by(id, ymd) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), max(SIC_30m_max), mean(SIC_30m_min), min(SIC_30m_min), mean(SICsq), mean(dist2land), max(start.swim), max(Bonepile)
    ) %>%
  ungroup()


```

```{r}

colnames(avg) <- c("id", "ymd", "animal", "SIC_mean", "SIC_maxMean", "SICmaxMax", "SIC_minMean", "SIC_minMin", "SICsq", "Dist2land", "start.swim", "Bonepile")

avg <- avg %>%
  group_by(id) %>%
  mutate(tstart = row_number()) %>%
  mutate(tstop = lead(tstart))

avg <- avg %>% # Change tstart and tstop to NA after start.swim = 1
  group_by(id) %>%
  mutate(across(starts_with('t'),
                ~replace(., row_number() > match(1, start.swim), NA)))

```


## SEA ICE CONCENTRATION 

First I determined which measurement of Sea Ice Concentration is best 

* SIC_max   = maximum sea ice concentation within 30 km radius
* SIC_mean  = mean sea ice concentration within 30 km radius
* SIC_min   = minimum sea ice concentration within 30 km radius
* SIC_sq    = mean sea ice concentration quadratic: SIC + SIC^2

```{r}

# CoxPH (baseline hazard not specified)

SIC_maxMean <- coxph(Surv(tstart, tstop, start.swim) ~ SIC_maxMean + cluster(animal), data = avg)
SIC_maxPH <- coxph(Surv(tstart, tstop, start.swim) ~ SICmaxMax + cluster(animal), data = avg)
SIC_maxmax_exp <- survreg(Surv(tstart, start.swim) ~ SIC_maxMean, data = avg, dist = "exponential", cluster = animal)

SIC_mean <- coxph(Surv(tstart, tstop, start.swim) ~ SIC_mean, data = avg)

SIC_sq <- coxph(Surv(tstart, tstop, start.swim) ~ SICsq, data = avg)

SIC_minMin <- coxph(Surv(tstart, tstop, start.swim) ~ SIC_minMin, data = avg)
SIC_minMean <- coxph(Surv(tstart, tstop, start.swim) ~ SIC_minMean, data = avg)


aicc <- AICc(SIC_maxMean, SIC_maxMax, SIC_mean, SIC_minMin, SIC_minMean, SIC_sq)

# Survreg (hazard assumed to be constant)

SICmaxExp <- survreg(Surv(tstart, start.swim) ~ SICmaxMax, data = avg, dist = "exponential", cluster = animal)
SICmean <- survreg(Surv(tstart, start.swim) ~ SIC_mean, data = avg, dist = "exponential", cluster = animal)
SICmin <- survreg(Surv(tstart, start.swim) ~ SIC_minMin, data = avg, dist = "exponential", cluster = animal)
SICsq <- survreg(Surv(tstart, start.swim) ~ SICsq, data = avg, dist = "exponential", cluster = animal)

aicc <- AICc(SICmax, SICmean, SICmin, SICsq)


create_AICc_table(aicc) # SIC Max is best model after going back through data and changing 120 --> 0 for land. Also after adding bears. 

```

```{r results='hide'}

# Combine three separate Movebank spreadsheets (data obtained in separate requests)

wind1 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_07032020.csv") 
wind2 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_10082020.csv")
wind3 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_10192020.csv")

wind1 <- dplyr::select(wind1, timestamp, location.long, location.lat, ht.above.ellipsoid, id, NCEP.NARR.FLX.U.Wind.at.10.m.above.Ground, NCEP.NARR.FLX.V.Wind.at.10.m.above.Ground) # eliminate other environmental variables like Chinook parameter

wind <- rbind(wind1, wind2, wind3)
wind$timestamp <- ymd_hms(wind$timestamp, tz = "UTC") # datetime imported as factor from csv. Change to POSIXct object.

# Eliminate ice bears (from wind1)

lb <- unique(bears$id)
wind <- subset(wind, wind$id %in% lb)
wind <- distinct(wind)

colnames(wind) <- c("datetime", "gps_lon", "gps_lat", "ht_above_ellips", "id", "Wind_U", "Wind_V") # wind vectors NCEP NARR FLX
wind$datetime <- with_tz(wind$datetime, "US/Alaska")

wind.join <- left_join(bears, wind, by = c("datetime","id", "gps_lon", "gps_lat"))

which(is.na(wind$Wind_U))
which(is.na(wind$Wind_V))
which(avg$start.swim == 1) # no start swim has NA for wind vectors - can delete these rows where wind = NA

rwind <- uv2ds(wind.join$Wind_U, wind.join$Wind_V)

wind.join <- cbind(wind.join, rwind)
wind.join$yday <- yday(wind.join$datetime)

# Categorize wind direction

wind.join <- wind.join %>%
  mutate(Wind_Type = ifelse(dir > 135 & dir < 225, "Onshore",
         ifelse(dir > 335 | dir < 45, "Offshore", "Crosswind")))

# Find average
# Note: for average "Wind Type", used 'first' direction of the day

avg2 <- wind.join %>% # Compute daily average
  group_by(id, yday) %>%
  dplyr::summarise(
    first(animal), max(SIC_30m_max), mean(SIC_30m_max), mean(dist2land), max(start.swim), mean(speed), mean(dir), max(Bonepile)
    ) %>%
  ungroup()




colnames(avg2) <- c("id", "tstart", "animal", "MaxSICmax", "MeanSICmax", "MeanDist2land", "start.swim", "MeanWindspeed", "MeanDir", "Bonepile") 

avg2 <- avg2 %>%
  group_by(id) %>%
  mutate(tstop = lead(tstart))


avg2 <- avg2 %>%
  group_by(id) %>%
  mutate(across(starts_with('t'),
                ~replace(., row_number() > match(1, start.swim), NA)))

```


```{r}

speed <- coxph(Surv(tstart, tstop, start.swim) ~ MeanWindspeed + cluster(animal), data = avg2)
SIC <- coxph(Surv(tstart, tstop, start.swim) ~ MaxSICmax, data = avg2)
Speed_SIC <- coxph(Surv(tstart, tstop, start.swim) ~ MeanWindspeed*MaxSICmax + cluster(animal), data = avg2)
distance <- coxph(Surv(tstart, tstop, start.swim) ~ MeanDist2land, data = avg2)
distSpeed <- coxph(Surv(tstart, tstop, start.swim) ~ MeanDist2land + MeanWindspeed, data = avg2)
distSpeedSIC <- coxph(Surv(tstart, tstop, start.swim) ~ MeanDist2land + MeanWindspeed * MaxSICmax + MeanWindspeed + MaxSICmax, data = avg2)
SpeedPlsSIC <- coxph(Surv(tstart, tstop, start.swim) ~ MeanWindspeed + MaxSICmax, data = avg2)
distSpeedPlsSIC <- coxph(Surv(tstart, tstop, start.swim) ~ MeanWindspeed + MaxSICmax + MeanDist2land, data = avg2)


aicc <- AICc(speed, SIC, Speed_SIC, distance, distSpeed, distSpeedSIC, SpeedPlsSIC, distSpeedPlsSIC)
create_AICc_table(aicc)


speed <- coxph(Surv(yday_start, yday_stop, start.swim) ~ windspeed, data = sub)
SIC <- coxph(Surv(yday_start, yday_stop, start.swim) ~ SIC_mean, data = sub)
Speed_SIC <- coxph(Surv(yday_start, yday_stop, start.swim) ~ windspeed + SIC_mean + windspeed*SIC_mean, data = sub)
SIC_speed_dist <- coxph(Surv(yday_start, yday_stop, start.swim) ~ SIC_mean + windspeed + SIC_mean*windspeed + Dist2land, data = sub)
full <- coxph(Surv(yday_start, yday_stop, start.swim) ~ SIC_mean + windspeed + SIC_mean*windspeed + Dist2land + repro, data = sub)



create_AICc_table(aicc)

aicc <- AICc(speed, SIC, Speed_SIC)

```

```{r}
# About the model: http://www.sthda.com/english/wiki/cox-proportional-hazards-model

summary(Speed_SIC)

```


z = Wald statistic value ( = ratio of each coefficient to its standard error) MaxSICmax is significant in and of itself but windspeed is not. The interaction is highly significant. 

All three overall tests (likelihood ratio, Wald test, logrank test) are significant. 

exp(coef) is the hazard ratio.  

```{r}

# Schoenfeld's residuals

zph <- cox.zph(Speed_SIC)
zph

plot(zph[2], lwd = 2)
abline(0,0, col = 1, lty = 3, lwd = 2)
abline(h= Speed_SIC$coef[2], col=3, lwd=2, lty=2)
legend("topleft",
legend=c('Reference line for null effect',
"Average hazard over time",
"Time-varying hazard"),
lty=c(3,2,1), col=c(1,3,1), lwd=2)
```






``` {r}
logreg <- select(logreg, -geometry)

logreg$repro <- 0

logreg <- logreg %>%
  mutate(repro = replace(repro, DenYr == 1, 1)) %>%
  mutate(repro = replace(repro, coy == 1, 2)) %>%
  mutate(repro = replace(repro, yearling == 1, 3))

logreg$repro <- factor(logreg$repro, labels = c("Unknown", "Denning", "COY", "Yearling"))

avg <- logreg %>% 
  group_by(id, ymd) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(SICsq), mean(dist2land[,1]), max(start.swim), first(repro), max(Bonepile)
    )

colnames(avg) <- c("id", "datetime", "animal", "SIC_mean", "SIC_max", "SIC_min", "SICsq", "Dist2land", "start.swim", "repro", "Bonepile")

avg$yday_start <- yday(avg$datetime) 

avg <- avg %>%
  mutate(yday_stop = lead(yday_start))

load("ded_ids.RData")

sub <- subset(avg, id %in% ded)

sub <- sub %>%
  group_by(id) %>%
  mutate(across(starts_with('yday'),
                ~replace(., row_number() > match(1, start.swim), NA)))

repro <- coxph(Surv(yday_start, yday_stop, start.swim) ~ repro, data = sub)

summary(repro)
```


No bears with COYS came ashore. Denning is significantly associated with cming to shore. Having a yearling is positively related to going to shore but the result is not significant. 

```{r}




```

