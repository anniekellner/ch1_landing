---
title: "CoxPH"
author: "Annie Kellner"
date: "8/24/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(lubridate)
library(rWind)
library(dplyr)
library(MuMIn)
#library(DescTools)
library(survival)
library(survminer)
library(tmap)
library(raster)
library(sf)

rm(list = ls())

```

```{r Functions}
# Functions

create_AICc_table <- function(aicc){ # AICc table function
  aicc$Model <- rownames(aicc)
  aicc$deltaAICc <- aicc$AICc - min(aicc$AICc) 
  aicc$L <- exp(-0.5*(aicc$deltaAICc))
  aicc$weight <- aicc$L/(sum(aicc$L))
  aicc$weight.pct <- aicc$weight*100
  aicc <- arrange(aicc, aicc$deltaAICc)
  return(aicc)
}

```


I included data from June 1 - Sept 30. In order to align the temporal resolution of the spatial data (e.g., one sea ice map per day) with the GPS data, I use daily averages for all environmental variables. 

```{r Prep Data}

load("./data/RData/land_bears_CoxPH.RData")
bears <- full

bears <- distinct(bears)

# Add SIC-squared

bears <- bears %>%
  mutate(SICsq = SIC_30m_me^2) 

```



```{r add wind}

# Combine three separate Movebank spreadsheets (data obtained in separate requests)

wind1 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_07032020.csv") 
wind2 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_10082020.csv")
wind3 <- read.csv("C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Data/Movebank/Movebank_10192020.csv")

wind1 <- dplyr::select(wind1, timestamp, location.long, location.lat, ht.above.ellipsoid, id, NCEP.NARR.FLX.U.Wind.at.10.m.above.Ground, NCEP.NARR.FLX.V.Wind.at.10.m.above.Ground) # eliminate other environmental variables like Chinook parameter

wind <- rbind(wind1, wind2, wind3)
wind$timestamp <- ymd_hms(wind$timestamp, tz = "UTC") # datetime imported as factor from csv. Change to POSIXct object.

# Eliminate ice bears (from wind1)

lb <- unique(bears$id)
wind <- subset(wind, wind$id %in% lb)
wind <- distinct(wind)

colnames(wind) <- c("datetime", "gps_lon", "gps_lat", "ht_above_ellips", "id", "Wind_U", "Wind_V") # wind vectors NCEP NARR FLX
wind$datetime <- with_tz(wind$datetime, "US/Alaska")

wind.join <- left_join(bears, wind, by = c("datetime","id", "gps_lon", "gps_lat"))

rwind <- uv2ds(wind.join$Wind_U, wind.join$Wind_V)

wind.join <- cbind(wind.join, rwind)
wind.join$yday <- yday(wind.join$datetime)

# Find average

avg <- wind.join %>% # Compute daily average
  group_by(id, yday) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(SICsq), mean(dist2land), max(start.swim), mean(speed), first(repro)) %>%
  ungroup()

colnames(avg) <- c("id", "ordinal_day", "animal", "SIC_mean", "SIC_max", "SIC_min", "SICsq", "MeanDist2land", "start.swim", "Windspeed", "repro") 

avg <- avg %>%
  group_by(id) %>%
  mutate(day = row_number()) 

avg <- avg %>%
  group_by(id) %>%
  mutate(across(everything(),
                ~replace(., row_number() > match(1, start.swim), NA)))

```

```{r use tmerge function to create tdc dataframe}

temp <- subset(avg, start.swim == 1)
temp <- temp %>%
  dplyr::select(id, day, start.swim, animal, repro) 

baseline <- tmerge(temp, temp, id = id, migrate = event(day, start.swim), tstart = 1, tstop = day)

cox_tdc <- tmerge(baseline, avg, id = id, SIC_mean = tdc(day, SIC_mean), SIC_max = tdc(day, SIC_max), SIC_min = tdc(day, SIC_min), SICsq = tdc(day, SICsq), Distance_to_land = tdc(day, MeanDist2land), Windspeed = tdc(day, Windspeed))

save(cox_tdc, file = "Cox_TDC.RData")

```


## SEA ICE CONCENTRATION 

First I determined which measurement of Sea Ice Concentration is best 

* SIC_max   = maximum sea ice concentation within 30 km radius
* SIC_mean  = mean sea ice concentration within 30 km radius
* SIC_min   = minimum sea ice concentration within 30 km radius
* SIC_sq    = mean sea ice concentration quadratic: SIC + SIC^2

```{r Sea Ice Concentration AIC}

# CoxPH (baseline hazard not specified)

SIC_max <- coxph(Surv(tstart, tstop, migrate) ~ SIC_max, cluster = id, data = cox_tdc)
#SIC_maxMax <- coxph(Surv(tstart, tstop, migrate) ~ SICmaxMax, , data = avg)
SIC_mean <- coxph(Surv(tstart, tstop, migrate) ~ SIC_mean, cluster = id, data = cox_tdc)

SIC_sq <- coxph(Surv(tstart, tstop, migrate) ~ SICsq, cluster = id, data = cox_tdc)

#SIC_min <- coxph(Surv(tstart, tstop, migrate) ~ SIC_min, cluster = id, data = cox_tdc) # Does not converge
#SIC_minMean <- coxph(Surv(tstart, tstop, migrate) ~ SIC_minMean, data = cox_tdc)

aicc <- AICc(SIC_mean, SIC_max, SIC_sq)

create_AICc_table(aicc) # SICsq is best way to measure SIC after changing 120 -> 0 and re-doing faulty numbers

```


```{r Model Selection}

# About the model: http://www.sthda.com/english/wiki/cox-proportional-hazards-model

speed <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed, cluster= animal, data = cox_tdc)
SIC <- coxph(Surv(tstart, tstop, migrate) ~ SICsq, cluster = animal, data = cox_tdc)
Speed_SIC <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed*SICsq, cluster = animal , data = cox_tdc)
distance <- coxph(Surv(tstart, tstop, migrate) ~ Distance_to_land, cluster = animal , data = cox_tdc)
distSpeed <- coxph(Surv(tstart, tstop, migrate) ~ Distance_to_land + Windspeed, cluster = animal, data = cox_tdc)
distSpeedSIC <- coxph(Surv(tstart, tstop, migrate) ~ Distance_to_land + Windspeed * SICsq + Windspeed + SICsq, cluster = animal, data = cox_tdc)
SpeedPlsSIC <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed + SICsq, cluster = animal, data = cox_tdc)
distSpeedPlsSIC <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed + SICsq + Distance_to_land, cluster = animal, data = cox_tdc)
null <- coxph(Surv(tstart, tstop, migrate) ~1, data = cox_tdc, cluster = animal)


aicc <- AICc(speed, SIC, Speed_SIC, distance, distSpeed, distSpeedSIC, SpeedPlsSIC, distSpeedPlsSIC, null)
aicc_table <- create_AICc_table(aicc)

write.csv(aicc_table, file = "C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Results/aicc.csv")

create_AICc_table(aicc)

summary(distSpeedPlsSIC)


```

z = Wald statistic value ( = ratio of each coefficient to its standard error) 

All three overall tests (likelihood ratio, Wald test, logrank test) are significant. 

exp(coef) is the hazard ratio.  

```{r Constant Hazard, eval=FALSE}

library(flexsurv)

speed_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Windspeed, data = cox_tdc, dist = "exp")
SIC_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ SICsq, data = cox_tdc, dist = "exp")
Speed_SIC_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Windspeed*SICsq, data = cox_tdc, dist = "exp")
distance_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Distance_to_land, data = cox_tdc, dist = "exp")
distSpeed_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Distance_to_land + Windspeed, data = cox_tdc, dist = "exp")
distSpeedSIC_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Distance_to_land + Windspeed * SICsq + Windspeed + SICsq, data = cox_tdc, dist = "exp")
SpeedPlsSIC_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Windspeed + SICsq, data = cox_tdc, dist = "exp")
distSpeedPlsSIC_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~ Windspeed + SICsq + Distance_to_land, data = cox_tdc, dist = "exp")
null_AFT <- flexsurvreg(Surv(tstart, tstop, migrate) ~1, data = cox_tdc, dist = "exp")

aicc <- AICc(speed_AFT, SIC_AFT, Speed_SIC_AFT, distance_AFT, distSpeed_AFT, distSpeedSIC_AFT, SpeedPlsSIC_AFT, distSpeedPlsSIC_AFT, null_AFT)

create_AICc_table(aicc)

```

Results are the same but model is more confusing and Nans are produced. 

```{r Moving Window for all variables - 3 days}

# 3 days

library(zoo)

cox_tdc <- cox_tdc %>%
  mutate(SICsq_3davg = rollmean(SICsq, 3, fill = NA, align = "right")) %>%
  mutate(Windspeed_3davg = rollmean(Windspeed, 3, fill = NA, align = "right")) %>%
  mutate(Dist2land_3davg = rollmean(Distance_to_land, 3, fill = NA, align = "right"))

# Same models using 3 day rolling averaqes for all variables

speed3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg, cluster= animal, data = cox_tdc)
SIC3 <- coxph(Surv(tstart, tstop, migrate) ~ SICsq_3davg, cluster = animal, data = cox_tdc)
Speed_SIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg*SICsq_3davg, cluster = animal , data = cox_tdc)
distance3 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg, cluster = animal , data = cox_tdc)
distSpeed3 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg, cluster = animal, data = cox_tdc)
distSpeedSIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg * SICsq_3davg, cluster = animal, data = cox_tdc)
SpeedPlsSIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq_3davg, cluster = animal, data = cox_tdc)
distSpeedPlsSIC3 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq_3davg + Dist2land_3davg, cluster = animal, data = cox_tdc)
null3 <- coxph(Surv(tstart, tstop, migrate) ~1, data = cox_tdc, cluster = animal)

# Test time x Windspeed interaction

test <- cox_tdc %>%
  mutate(time = row_number())

test$time <- as.numeric(test$time)
test2 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg*time, cluster = animal, data = test)

aicc <- AICc(test2, speed3)
# Model is not improved with Windspeed * time interaction 


aicc <- AICc(speed3, SIC3, Speed_SIC3, distance3, distSpeed3, distSpeedSIC3, SpeedPlsSIC3, distSpeedPlsSIC3, null3)
create_AICc_table(aicc)

summary(distSpeedPlsSIC3)

```

# Rolling day average for Distance and Speed but same day values for SIC

```{r Moving window for Speed and Distance but not SIC - 3 days, eval=FALSE}

SIC4 <- coxph(Surv(tstart, tstop, migrate) ~ SICsq, cluster = animal, data = cox_tdc)
Speed_SIC4 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg*SICsq, cluster = animal , data = cox_tdc)
distSpeedSIC4 <- coxph(Surv(tstart, tstop, migrate) ~ Dist2land_3davg + Windspeed_3davg * SICsq, cluster = animal, data = cox_tdc)
SpeedPlsSIC4 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq, cluster = animal, data = cox_tdc)
distSpeedPlsSIC4 <- coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + SICsq + Dist2land_3davg, cluster = animal, data = cox_tdc)

aicc <- AICc(speed3, SIC4, Speed_SIC4, distance3, distSpeed3, distSpeedSIC4, SpeedPlsSIC4, distSpeedPlsSIC4, null)
create_AICc_table(aicc)

# Similar results to above but less sensible

```



```{r Schoenfeld's Residuals}

# Schoenfeld's residuals

# How to deal with invalid assumptions for Cox model: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6015946/


zph <- cox.zph(distSpeed3)
zph # p > 0.05 for all variables in top two 3-day models

plot(zph[2], lwd = 2)
abline(0,0, col = 1, lty = 3, lwd = 2)
abline(h= distSpeed3$coef[2], col=3, lwd=2, lty=2)
legend("topleft",
legend=c('Reference line for null effect',
"Average hazard over time",
"Time-varying hazard"),
lty=c(3,2,1), col=c(1,3,1), lwd=2)
```
```{r CHeck Assumptions: Influential Observations/Outliers}

# Test for influential observations

ggcoxdiagnostics(distSpeed3, type = "dfbeta", linear.predictions = FALSE, ggtheme = theme_bw())

```
Observations may be relatively large or small but none are influential (because the values on the y-axis are very low)

```{r Check Assumptions: Non-linearity}

cox_tdc <- na.omit(cox_tdc)

ggcoxfunctional(coxph(Surv(tstart, tstop, migrate) ~ Windspeed_3davg + log(Windspeed_3davg) + sqrt(Windspeed_3davg), cluster = animal, data = cox_tdc))


```

```{r Correlation matrix}

vars <- dplyr::select(cox_tdc, SICsq_3davg, Windspeed_3davg, Dist2land_3davg)

res <- cor(vars)
res


```


# Plots

```{r}

fit <- survfit(Surv(tstart, tstop, start.swim) ~ Windspeed + SICsq, , data = avg2) # SIC + Speed - this doesn't work


ggadjustedcurves()

ggsurvplot(fit, data = avg2)

```

# Reproduction

``` {r}

bears$repro <- 0

bears <- bears %>%
  mutate(repro = replace(repro, go_into_den == 1, 1)) %>%
  mutate(repro = replace(repro, coy == 1, 2)) %>%
  mutate(repro = replace(repro, yearling == 1, 3))

bears$repro <- factor(bears$repro, labels = c("Unknown", "Enter_Den", "COY", "Yearling"))

avg <- bears %>% 
  group_by(id, ymd) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(SICsq), mean(dist2land[,1]), max(start.swim), first(repro), max(Bonepile)
    )

colnames(avg) <- c("id", "datetime", "animal", "SIC_mean", "SIC_max", "SIC_min", "SICsq", "Dist2land", "start.swim", "repro", "Bonepile")

avg$yday_start <- yday(avg$datetime) 

avg <- avg %>%
  mutate(yday_stop = lead(yday_start))

#load("ded_ids.RData")

#sub <- subset(avg, id %in% ded)

avg <- avg %>%
  group_by(id) %>%
  mutate(across(starts_with('yday'),
                ~replace(., row_number() > match(1, start.swim), NA)))

repro <- coxph(Surv(yday_start, yday_stop, start.swim) ~ repro, data = avg)

summary(repro)
```


No bears with COYS came ashore. Denning is significantly associated with cming to shore. Having a yearling is positively related to going to shore but the result is not significant. 

```{r}




```

