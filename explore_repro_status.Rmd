---
title: "Explore_Repro_Status"
author: "Annie Kellner"
date: "11/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

load("land_bears_CoxPH.RData")
```

```{r}

# Functions

create_AICc_table <- function(aicc){ # AICc table function
  aicc$Model <- rownames(aicc)
  aicc$deltaAICc <- aicc$AICc - min(aicc$AICc) 
  aicc$L <- exp(-0.5*(aicc$deltaAICc))
  aicc$weight <- aicc$L/(sum(aicc$L))
  aicc$weight.pct <- aicc$weight*100
  aicc <- arrange(aicc, aicc$deltaAICc)
  return(aicc)
}

```


First test whether reproductive status affects timing of migration. Reproductive status characterized as either Enter_Den, coy, yearling, or unknown.

```{r cars}

bears$repro <- 0

bears <- bears %>%
  mutate(repro = replace(repro, go_into_den == 1, 1)) %>%
  mutate(repro = replace(repro, coy == 1, 2)) %>%
  mutate(repro = replace(repro, yearling == 1, 3))

bears$repro <- factor(bears$repro, labels = c("Unknown", "Enter_Den", "COY", "Yearling"))

avg <- bears %>% 
  group_by(id, ymd) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(SICsq), mean(dist2land[,1]), max(start.swim), first(repro), max(Bonepile)
    )

colnames(avg) <- c("id", "datetime", "animal", "SIC_mean", "SIC_max", "SIC_min", "SICsq", "Dist2land", "start.swim", "repro", "Bonepile")

avg$yday_start <- yday(avg$datetime) 

avg <- avg %>%
  mutate(yday_stop = lead(yday_start))


avg <- avg %>%
  group_by(id) %>%
  mutate(across(starts_with('yday'),
                ~replace(., row_number() > match(1, start.swim), NA)))

repro <- coxph(Surv(yday_start, yday_stop, start.swim) ~ repro, data = avg)

summary(repro)
```

Now see whether repro status is significant if variable is binary: 1 = dependent offspring, 0 = no dependent offspring

```{r pressure, echo=FALSE}

bears$repro <- 0

bears <- bears %>%
  mutate(repro = replace(repro, go_into_den == 1, 0)) %>%
  mutate(repro = replace(repro, coy == 1, 1)) %>%
  mutate(repro = replace(repro, yearling == 1, 1))

avg <- bears %>% 
  group_by(id, ymd) %>%
  dplyr::summarise(
    first(animal), mean(SIC_30m_me), mean(SIC_30m_max), mean(SIC_30m_min), mean(dist2land[,1]), max(start.swim), first(repro), max(Bonepile)
    )

colnames(avg) <- c("id", "datetime", "animal", "SIC_mean", "SIC_max", "SIC_min", "Dist2land", "start.swim", "repro", "Bonepile")

avg$tstart <- yday(avg$datetime) 

avg <- avg %>%
  mutate(tstop = lead(tstart))

avg <- avg %>%
  group_by(id) %>%
  mutate(across(starts_with('yday'),
                ~replace(., row_number() > match(1, start.swim), NA)))

repro <- coxph(Surv(tstart, tstop, start.swim) ~ repro, data = avg)

summary(repro)

```

It does not appear that reproductive status affects the timing of migration. But does it affect the decision to migrate?

```{r Add ice bears}

ice <- subset(all.v2, ows == 1 & land_bear_ows == 0)

noData <- ice %>% # remove bears with < 100 data points
 add_count(id) %>%
  filter(n < 100)

noData2 <- ice %>%
  filter(id == "pb_20296.2015" | id == "pb_20423.2014" | id == "pb_20474.2009" | id == "pb_20520.2013" |
          id == "pb_20520.2012" | id == "pb_20521.2014" | id == "pb_20694.2004" | id == "pb_20783.2005" | id == "pb_20845.2009" |id == "pb_20910.2009" | id == "pb_20965.2008" | id == "pb_20982.2008" | id == "pb_21015.2012" | 
          id == "pb_21015.2014" | id == "pb_21291.2013" | id == "pb_21307.2013" | id == "pb_21343.2015" | id == "pb_21402.2016" | id == "pb_21403.2016" | id == "pb_22299.2015" | id == "pb_22305.2015" | id == "pb_22318.2016" | id == "pb_32362.2015" | id == "pb_32608.2008" | id == "pb_32921.2016")  # all bears with < 2 mos data after visual inspection 11/21/20

ice <- anti_join(ice, noData)
ice <- anti_join(ice, noData2)

ice <- droplevels(ice)

save(ice, file = "C:/Users/akell/OneDrive - Colostate/PhD/Polar_Bears/Repos/ch1_landing/ice_bears_CoxPH.RData")

```



```{r Merge denning data}

# TO DO: instead of migrate, do 'land bears' 

load('land_bears_CoxPH.RData')
load('ice_bears_CoxPH.RData')

ice2 <- dplyr::select(ice, animal, year, datetime, start.swim, land_bear)
land <- dplyr::select(bears, animal, year, datetime, start.swim, land_bear)

bears_cox <- rbind(ice2, land)

# Import csv - denning data from TA (Lillie et al. 2018)

den <- read.csv('C:/Users/akell/Documents/PhD/Polar_Bears/Data/Repro/Repro.csv')
den <- select(den, 1,2,4,5,6)
den$id <- paste(den$animal, den$year, sep = '.')

infer <- den %>%
  filter(id == "pb_20521.2014" | id == "pb_20525.2014" | id == "pb_20794.2006" | id == "pb_20797.2006" | id == "pb_20840.2007" | id == "pb_20925" | id == "pb_21219.2011")

den <- anti_join(den, infer)

bears_cox <- full_join(bears_cox, den) # Join repro data
head(bears_cox)

# Consolidate repro data into a single column with factors

bears_cox$repro <- NA

bears_cox <- bears_cox %>%
  mutate(repro = replace(repro, DenYr == 1, "enter_den")) %>%
  mutate(repro = replace(repro, coy == 1, "coy")) %>%
  mutate(repro = replace(repro, yearling == 1, "yearling"))
  
bears_cox$ordinal <- yday(bears_cox$datetime)

bears_cox <- bears_cox %>%
  group_by(id, ordinal) %>%
  summarise(first(animal), first(year), max(start.swim), first(repro), max(land_bear))

colnames(bears_cox) <- c("id", "ordinal", "animal", "year", "migrate", "repro", "land_bear")

bears_cox$repro <- as.factor(bears_cox$repro)



```


```{r Run CoxPH with repro as factors}
repro_fit <- coxph(Surv(ordinal, land_bear) ~ repro, cluster = id, data = bears_cox)

summary(repro_fit) # not significant

```

When bears' repro status is divided into 3 factors, the result is not significant. There is no increased or decreased risk of migration for any of the factors. I removed all incomplete data and bears for which reproductive status was assumed but not confirmed.

```{r All bears binary offspring v no offspring}

bears_cox <- na.omit(bears_cox)

bears_cox <- bears_cox %>%
  mutate(depend_offspring = ifelse(repro == "coy" | repro == "yearling", 1, 0))

fit_binary <- coxph(Surv(ordinal, land_bear) ~ depend_offspring, cluster = id, data = bears_cox)

summary(fit_binary)

```

Reproductive status is still not significant when all bears are considered. Should check to make sure all bears included are appropriate. Reproductive status is also not significant  

```{r}
coys <- subset(bears_cox, repro == "coy")

table(coys$id, coys$land_bear)
```


